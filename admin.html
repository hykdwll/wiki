<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çŸ¥è¯†åº“ç®¡ç†</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
    }
    .tree-view {
      margin-bottom: 20px;
    }
    .tree-view ul {
      list-style-type: none;
      padding-left: 20px;
    }
    .tree-view li {
      margin: 5px 0;
    }
    .clickable {
      cursor: pointer;
      color: #0d6efd;
    }
    .selected {
      font-weight: bold;
      color: #0b5ed7;
    }
    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .file-item:hover {
      background-color: #f8f9fa;
    }
    .file-actions {
      visibility: hidden;
    }
    .file-item:hover .file-actions {
      visibility: visible;
    }
    .back-to-home {
      position: fixed;
      right: 20px;
      top: 20px;
      z-index: 100;
    }
  </style>
</head>
<body>
  <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
  <a href="/" class="btn btn-outline-primary back-to-home">
    <i class="bi bi-house-door"></i> è¿”å›é¦–é¡µ
  </a>

  <div class="container">
    <div class="row mb-4">
      <div class="col">
        <h1>çŸ¥è¯†åº“ç®¡ç†</h1>
        <p class="text-muted">ä¸Šä¼  Markdown æ–‡ä»¶åˆ°çŸ¥è¯†åº“ï¼Œå¹¶ç®¡ç†ç›®å½•ç»“æ„</p>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>ç›®å½•ç»“æ„</span>
            <button class="btn btn-sm btn-primary" id="addDirBtn">æ–°å»ºç›®å½•</button>
          </div>
          <div class="card-body">
            <div id="directoryTree" class="tree-view">
              <!-- ç›®å½•ç»“æ„å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
              </div>
              <span>æ­£åœ¨åŠ è½½ç›®å½•...</span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="card mb-4">
          <div class="card-header">ä¸Šä¼  Markdown æ–‡ä»¶</div>
          <div class="card-body">
            <form id="uploadForm">
              <div class="mb-3">
                <label for="fileInput" class="form-label">é€‰æ‹© Markdown æ–‡ä»¶</label>
                <input type="file" class="form-control" id="fileInput" accept=".md" required>
              </div>
              <div class="mb-3">
                <label for="targetDir" class="form-label">ç›®æ ‡ç›®å½•</label>
                <input type="text" class="form-control" id="targetDir" readonly value="">
                <div class="form-text">è¯·åœ¨å·¦ä¾§ç›®å½•æ ‘ä¸­é€‰æ‹©ä¸€ä¸ªç›®å½•</div>
                <div id="targetDirHelper" class="form-text" style="display: none;"></div>
              </div>
              <div class="mb-3">
                <label for="customName" class="form-label">ç¬”è®°åç§°ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" class="form-control" id="customName" placeholder="é»˜è®¤ä½¿ç”¨æ–‡ä»¶å">
                <div class="form-text">ä¸å¡«å†™åˆ™ä½¿ç”¨åŸæ–‡ä»¶å</div>
              </div>
              <button type="submit" class="btn btn-primary" id="uploadBtn">ä¸Šä¼ æ–‡ä»¶</button>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-header">å½“å‰ç›®å½•æ–‡ä»¶</div>
          <div class="card-body">
            <div id="filesList">
              <p class="text-muted">è¯·é€‰æ‹©ä¸€ä¸ªç›®å½•ä»¥æŸ¥çœ‹å…¶ä¸­çš„æ–‡ä»¶</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¨¡æ€æ¡†ï¼šæ–°å»ºç›®å½• -->
  <div class="modal fade" id="newDirModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">æ–°å»ºç›®å½•</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="newDirForm">
            <div class="mb-3">
              <label for="parentDir" class="form-label">çˆ¶ç›®å½•</label>
              <input type="text" class="form-control" id="parentDir" readonly>
            </div>
            <div class="mb-3">
              <label for="dirName" class="form-label">ç›®å½•åç§°</label>
              <input type="text" class="form-control" id="dirName" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="createDirBtn">åˆ›å»º</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¨¡æ€æ¡†ï¼šé‡å‘½åç›®å½• -->
  <div class="modal fade" id="renameDirModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">é‡å‘½åç›®å½•</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="renameDirForm">
            <div class="mb-3">
              <label for="currentDirPath" class="form-label">ç›®å½•è·¯å¾„</label>
              <input type="text" class="form-control" id="currentDirPath" readonly>
            </div>
            <div class="mb-3">
              <label for="currentDirName" class="form-label">å½“å‰åç§°</label>
              <input type="text" class="form-control" id="currentDirName" readonly>
            </div>
            <div class="mb-3">
              <label for="newDirName" class="form-label">æ–°åç§°</label>
              <input type="text" class="form-control" id="newDirName" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="saveDirRenameBtn">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¨¡æ€æ¡†ï¼šé‡å‘½åæ–‡ä»¶ -->
  <div class="modal fade" id="renameFileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">é‡å‘½åæ–‡ä»¶</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="renameFileForm">
            <div class="mb-3">
              <label for="fileDirectory" class="form-label">æ–‡ä»¶è·¯å¾„</label>
              <input type="text" class="form-control" id="fileDirectory" readonly>
            </div>
            <div class="mb-3">
              <label for="currentFileName" class="form-label">å½“å‰åç§°</label>
              <input type="text" class="form-control" id="currentFileName" readonly>
            </div>
            <div class="mb-3">
              <label for="newFileName" class="form-label">æ–°åç§°</label>
              <input type="text" class="form-control" id="newFileName" required>
              <div class="form-text">æ— éœ€æ·»åŠ .mdæ‰©å±•å</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="saveFileRenameBtn">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¨¡æ€æ¡†ï¼šä¿®æ”¹ç›®å½•æ˜¾ç¤ºåç§° -->
  <div class="modal fade" id="changeDisplayNameModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ä¿®æ”¹æ˜¾ç¤ºåç§°</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="changeDisplayNameForm">
            <div class="mb-3">
              <label for="displayNameDirPath" class="form-label">ç›®å½•è·¯å¾„</label>
              <input type="text" class="form-control" id="displayNameDirPath" readonly>
            </div>
            <div class="mb-3">
              <label for="currentDisplayName" class="form-label">å½“å‰æ˜¾ç¤ºåç§°</label>
              <input type="text" class="form-control" id="currentDisplayName" readonly>
            </div>
            <div class="mb-3">
              <label for="newDisplayName" class="form-label">æ–°æ˜¾ç¤ºåç§°</label>
              <input type="text" class="form-control" id="newDisplayName" required>
              <div class="form-text text-info">æ³¨æ„ï¼šæ­¤æ“ä½œåªä¿®æ”¹ä¾§è¾¹æ æ˜¾ç¤ºçš„åç§°ï¼Œä¸æ”¹å˜å®é™…æ–‡ä»¶è·¯å¾„</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="saveDisplayNameBtn">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // å…¨å±€å˜é‡
    let selectedDirectory = '';
    const modals = {};
    let directoryMapping = {}; // å­˜å‚¨ç›®å½•è·¯å¾„ä¸æ˜¾ç¤ºåç§°çš„æ˜ å°„

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // è·å–æ¨¡æ€æ¡†å®ä¾‹
      modals.newDir = new bootstrap.Modal(document.getElementById('newDirModal'));
      modals.renameDir = new bootstrap.Modal(document.getElementById('renameDirModal'));
      modals.renameFile = new bootstrap.Modal(document.getElementById('renameFileModal'));
      modals.changeDisplayName = new bootstrap.Modal(document.getElementById('changeDisplayNameModal'));

      // é¦–å…ˆåŠ è½½ä¾§è¾¹æ æ˜ å°„
      fetchSidebarMapping().then(() => {
        // ç„¶ååŠ è½½ç›®å½•ç»“æ„
        fetchDirectories();
      });
      
      // è¡¨å•æäº¤å¤„ç†
      document.getElementById('uploadForm').addEventListener('submit', uploadFile);
      
      // æ–°å»ºç›®å½•æŒ‰é’®
      document.getElementById('addDirBtn').addEventListener('click', showNewDirModal);
      document.getElementById('createDirBtn').addEventListener('click', createDirectory);
      
      // é‡å‘½åä¿å­˜æŒ‰é’®
      document.getElementById('saveDirRenameBtn').addEventListener('click', saveDirectoryRename);
      document.getElementById('saveFileRenameBtn').addEventListener('click', saveFileRename);
      
      // æ˜¾ç¤ºåç§°ä¿å­˜æŒ‰é’®
      document.getElementById('saveDisplayNameBtn').addEventListener('click', saveDisplayNameChange);
    });

    // è·å–ä¾§è¾¹æ æ˜ å°„
    async function fetchSidebarMapping() {
      try {
        console.log('æ­£åœ¨è·å–ä¾§è¾¹æ æ˜ å°„...');
        const timestamp = new Date().getTime(); // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
        const response = await fetch(`/api/sidebar-mapping?t=${timestamp}`);
        if (!response.ok) {
          throw new Error('è·å–ä¾§è¾¹æ æ˜ å°„å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : ' + response.status);
        }
        
        directoryMapping = await response.json();
        console.log('æˆåŠŸè·å–ä¾§è¾¹æ æ˜ å°„:', directoryMapping);
        return directoryMapping;
      } catch (error) {
        console.error('è·å–ä¾§è¾¹æ æ˜ å°„å¤±è´¥:', error);
        // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­ï¼Œä½¿ç”¨é»˜è®¤ç›®å½•å
        return {};
      }
    }

    // è·å–ç›®å½•ç»“æ„
    async function fetchDirectories() {
      try {
        console.log('æ­£åœ¨è¯·æ±‚ç›®å½•ç»“æ„...');
        document.getElementById('directoryTree').innerHTML = `
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
          </div>
          <span>æ­£åœ¨åŠ è½½ç›®å½•...</span>
        `;

        const response = await fetch('/api/directories', {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin'
        });
        
        if (!response.ok) {
          let errorText = '';
          try {
            const errorData = await response.json();
            errorText = errorData.message || errorData.error || 'æœåŠ¡å™¨è¿”å›é”™è¯¯çŠ¶æ€ç : ' + response.status;
          } catch (e) {
            errorText = 'æœåŠ¡å™¨è¿”å›é”™è¯¯çŠ¶æ€ç : ' + response.status;
          }
          
          throw new Error(errorText);
        }
        
        const directories = await response.json();
        console.log('æˆåŠŸè·å–ç›®å½•ç»“æ„:', directories);
        
        if (!Array.isArray(directories)) {
          throw new Error('æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œé¢„æœŸæ˜¯æ•°ç»„');
        }
        
        renderDirectoryTree(directories, document.getElementById('directoryTree'));
      } catch (error) {
        console.error('è·å–ç›®å½•ç»“æ„å¤±è´¥:', error);
        document.getElementById('directoryTree').innerHTML = `
          <div class="alert alert-danger">
            è·å–ç›®å½•ç»“æ„å¤±è´¥: ${error.message}
            <hr>
            <p>è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œå¹¶å°è¯•ä»¥ä¸‹è§£å†³æ–¹æ¡ˆ:</p>
            <ol>
              <li>åˆ·æ–°é¡µé¢é‡è¯•</li>
              <li>æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯</li>
              <li>ç¡®è®¤æœåŠ¡å™¨åœ°å€æ­£ç¡®</li>
            </ol>
            <button class="btn btn-sm btn-primary mt-2" onclick="fetchDirectories()">é‡è¯•</button>
          </div>
        `;
      }
    }

    // æ¸²æŸ“ç›®å½•æ ‘
    function renderDirectoryTree(directories, container) {
      container.innerHTML = '';
      
      const ul = document.createElement('ul');
      directories.forEach(dir => {
        const li = document.createElement('li');
        
        // è·å–ç›®å½•çš„æ˜¾ç¤ºåç§°ï¼ˆä½¿ç”¨æ˜ å°„æˆ–é»˜è®¤åç§°ï¼‰
        const displayName = getDisplayName(dir.path, dir.name);
        
        const dirSpan = document.createElement('span');
        dirSpan.textContent = `ğŸ“ ${displayName}`;
        dirSpan.className = 'clickable';
        dirSpan.dataset.path = dir.path;
        dirSpan.dataset.displayName = displayName;
        dirSpan.dataset.originalName = dir.name;
        dirSpan.addEventListener('click', () => selectDirectory(dir.path, dirSpan, displayName));
        
        // æ·»åŠ æ“ä½œæŒ‰é’®
        const dirActions = document.createElement('span');
        dirActions.className = 'ms-2 directory-actions';
        
        // ä¿®æ”¹æ˜¾ç¤ºåç§°æŒ‰é’®ï¼ˆæ–°å¢ï¼‰
        const changeDisplayBtn = document.createElement('button');
        changeDisplayBtn.className = 'btn btn-sm btn-outline-primary me-1';
        changeDisplayBtn.textContent = 'ä¿®æ”¹æ˜¾ç¤ºåç§°';
        changeDisplayBtn.title = 'åªä¿®æ”¹ä¾§è¾¹æ ä¸­æ˜¾ç¤ºçš„åç§°ï¼Œä¸æ”¹å˜å®é™…æ–‡ä»¶è·¯å¾„';
        changeDisplayBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          showChangeDisplayNameModal(dir.path, displayName);
        });
        
        // é‡å‘½åè·¯å¾„æŒ‰é’®ï¼ˆä¿®æ”¹æ–‡æ¡ˆä»¥åŒºåˆ†ï¼‰
        const renameBtn = document.createElement('button');
        renameBtn.className = 'btn btn-sm btn-outline-secondary me-1';
        renameBtn.textContent = 'é‡å‘½åè·¯å¾„';
        renameBtn.title = 'ä¿®æ”¹å®é™…æ–‡ä»¶ç³»ç»Ÿè·¯å¾„åç§°';
        renameBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          showRenameDirModal(dir.path, dir.name, displayName);
        });
        
        // åˆ é™¤æŒ‰é’®
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.textContent = 'åˆ é™¤';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          confirmDeleteDirectory(dir.path, displayName);
        });
        
        dirActions.appendChild(changeDisplayBtn);
        dirActions.appendChild(renameBtn);
        dirActions.appendChild(deleteBtn);
        
        li.appendChild(dirSpan);
        li.appendChild(dirActions);
        
        if (dir.children && dir.children.length > 0) {
          const childContainer = document.createElement('div');
          renderDirectoryTree(dir.children, childContainer);
          li.appendChild(childContainer);
        }
        
        ul.appendChild(li);
      });
      
      container.appendChild(ul);
    }

    // è·å–ç›®å½•çš„æ˜¾ç¤ºåç§°
    function getDisplayName(path, defaultName) {
      console.log('è·å–æ˜¾ç¤ºåç§°:', path, directoryMapping[path]);
      if (directoryMapping && directoryMapping[path]) {
        return directoryMapping[path];
      }
      return defaultName;
    }

    // é€‰æ‹©ç›®å½•
    function selectDirectory(path, element, displayName) {
      // æ¸…é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.tree-view .selected').forEach(el => {
        el.classList.remove('selected');
      });
      
      // æ ‡è®°å½“å‰é€‰ä¸­
      element.classList.add('selected');
      
      // æ›´æ–°å…¨å±€å˜é‡
      selectedDirectory = path;
      
      // æ›´æ–°è¡¨å•ä¸­çš„ç›®æ ‡ç›®å½•ï¼ˆæ˜¾ç¤ºè·¯å¾„ï¼‰
      document.getElementById('targetDir').value = path;
      
      // å¦‚æœæœ‰æ˜¾ç¤ºåç§°ä¸åŒäºè·¯å¾„ï¼Œåˆ™åœ¨ç›®æ ‡ç›®å½•è¾“å…¥æ¡†ä¸‹æ–¹æ˜¾ç¤º
      const targetDirHelper = document.getElementById('targetDirHelper');
      if (displayName && displayName !== path.split('/').pop()) {
        targetDirHelper.textContent = `å½“å‰é€‰æ‹©: ${displayName} (${path})`;
        targetDirHelper.style.display = 'block';
      } else {
        targetDirHelper.style.display = 'none';
      }
      
      // åŠ è½½æ–‡ä»¶åˆ—è¡¨
      fetchFiles(path);
    }

    // è·å–ç›®å½•ä¸‹çš„æ–‡ä»¶
    async function fetchFiles(dirPath) {
      try {
        const response = await fetch(`/api/files?path=${encodeURIComponent(dirPath)}`);
        const data = await response.json();
        
        if (data.success) {
          renderFilesList(data.files, dirPath);
        } else {
          document.getElementById('filesList').innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
      } catch (error) {
        console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('filesList').innerHTML = '<div class="alert alert-danger">è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥</div>';
      }
    }

    // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
    function renderFilesList(files, dirPath) {
      const container = document.getElementById('filesList');
      container.innerHTML = '';
      
      if (files.length === 0) {
        container.innerHTML = '<p class="text-muted">å½“å‰ç›®å½•æ²¡æœ‰Markdownæ–‡ä»¶</p>';
        return;
      }
      
      files.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        const fileName = document.createElement('span');
        // ä¸æ˜¾ç¤ºREADME.mdæ–‡ä»¶
        if (file.name === 'README.md') {
          fileName.innerHTML = `<em class="text-muted">ğŸ“„ ${file.name} (ç›®å½•ç´¢å¼•æ–‡ä»¶)</em>`;
        } else {
          fileName.textContent = `ğŸ“„ ${file.name}`;
        }
        
        const fileActions = document.createElement('div');
        fileActions.className = 'file-actions';
        
        // åªå¯¹éREADME.mdæ–‡ä»¶æ˜¾ç¤ºæ“ä½œæŒ‰é’®
        if (file.name !== 'README.md') {
          // é‡å‘½åæŒ‰é’®
          const renameBtn = document.createElement('button');
          renameBtn.className = 'btn btn-sm btn-outline-secondary me-1';
          renameBtn.textContent = 'é‡å‘½å';
          renameBtn.addEventListener('click', () => showRenameFileModal(dirPath, file.name));
          
          // åˆ é™¤æŒ‰é’®
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-sm btn-outline-danger';
          deleteBtn.textContent = 'åˆ é™¤';
          deleteBtn.addEventListener('click', () => confirmDeleteFile(dirPath + '/' + file.name, file.name));
          
          fileActions.appendChild(renameBtn);
          fileActions.appendChild(deleteBtn);
        }
        
        fileItem.appendChild(fileName);
        fileItem.appendChild(fileActions);
        container.appendChild(fileItem);
      });
    }

    // ä¸Šä¼ æ–‡ä»¶
    async function uploadFile(e) {
      e.preventDefault();
      
      const fileInput = document.getElementById('fileInput');
      const targetDir = document.getElementById('targetDir').value;
      const customName = document.getElementById('customName').value;
      
      if (!fileInput.files[0]) {
        alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
        return;
      }
      
      if (!targetDir) {
        alert('è¯·é€‰æ‹©ç›®æ ‡ç›®å½•');
        return;
      }
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('targetDirectory', targetDir);
      
      if (customName) {
        formData.append('customName', customName);
      }
      
      try {
        const uploadBtn = document.getElementById('uploadBtn');
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ä¸Šä¼ ä¸­...';
        
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
          // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
          fetchFiles(targetDir);
          // æ¸…ç©ºè¡¨å•
          document.getElementById('uploadForm').reset();
        } else {
          alert(`ä¸Šä¼ å¤±è´¥: ${result.message}`);
        }
      } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);
        alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
      } finally {
        const uploadBtn = document.getElementById('uploadBtn');
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'ä¸Šä¼ æ–‡ä»¶';
      }
    }

    // æ˜¾ç¤ºæ–°å»ºç›®å½•æ¨¡æ€æ¡†
    function showNewDirModal() {
      document.getElementById('parentDir').value = selectedDirectory || '';
      document.getElementById('dirName').value = '';
      modals.newDir.show();
    }

    // åˆ›å»ºç›®å½•
    async function createDirectory() {
      const parentDir = document.getElementById('parentDir').value;
      const dirName = document.getElementById('dirName').value;
      
      if (!dirName) {
        alert('è¯·è¾“å…¥ç›®å½•åç§°');
        return;
      }
      
      try {
        const response = await fetch('/api/directory', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: parentDir, name: dirName })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('ç›®å½•åˆ›å»ºæˆåŠŸ');
          modals.newDir.hide();
          // åˆ·æ–°ç›®å½•æ ‘
          fetchDirectories();
        } else {
          alert(`åˆ›å»ºç›®å½•å¤±è´¥: ${result.message}`);
        }
      } catch (error) {
        console.error('åˆ›å»ºç›®å½•å¤±è´¥:', error);
        alert('åˆ›å»ºç›®å½•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
      }
    }

    // æ˜¾ç¤ºé‡å‘½åç›®å½•æ¨¡æ€æ¡†
    function showRenameDirModal(dirPath, dirName, displayName) {
      // è·å–çˆ¶ç›®å½•è·¯å¾„
      const pathParts = dirPath.split('/');
      const parentPath = pathParts.slice(0, -1).join('/');
      
      document.getElementById('currentDirPath').value = parentPath;
      document.getElementById('currentDirName').value = dirName;
      
      // æ˜¾ç¤ºå½“å‰æ˜¾ç¤ºåç§°è€Œä¸æ˜¯è·¯å¾„åç§°
      document.getElementById('newDirName').value = displayName || dirName;
      
      // æ·»åŠ é¢å¤–ä¿¡æ¯æç¤º
      const dirNameHelp = document.getElementById('dirNameHelp') || 
                          document.querySelector('#renameDirModal .form-text');
      if (dirNameHelp) {
        dirNameHelp.textContent = `åŸè·¯å¾„åç§°: ${dirName}, å½“å‰æ˜¾ç¤ºåç§°: ${displayName || dirName}`;
      }
      
      modals.renameDir.show();
    }

    // ä¿å­˜ç›®å½•é‡å‘½å
    async function saveDirectoryRename() {
      const dirPath = document.getElementById('currentDirPath').value;
      const oldName = document.getElementById('currentDirName').value;
      const newName = document.getElementById('newDirName').value;
      
      if (!newName) {
        alert('è¯·è¾“å…¥æ–°çš„ç›®å½•åç§°');
        return;
      }
      
      try {
        const response = await fetch('/api/directory', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: dirPath, oldName, newName })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('ç›®å½•é‡å‘½åæˆåŠŸ');
          modals.renameDir.hide();
          // åˆ·æ–°ç›®å½•æ ‘
          fetchDirectories();
        } else {
          alert(`é‡å‘½åç›®å½•å¤±è´¥: ${result.message}`);
        }
      } catch (error) {
        console.error('é‡å‘½åç›®å½•å¤±è´¥:', error);
        alert('é‡å‘½åç›®å½•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
      }
    }

    // æ˜¾ç¤ºé‡å‘½åæ–‡ä»¶æ¨¡æ€æ¡†
    function showRenameFileModal(dirPath, fileName) {
      document.getElementById('fileDirectory').value = dirPath;
      document.getElementById('currentFileName').value = fileName;
      
      // å»æ‰.mdåç¼€æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†
      const nameWithoutExt = fileName.replace(/\.md$/, '');
      document.getElementById('newFileName').value = nameWithoutExt;
      
      modals.renameFile.show();
    }

    // ä¿å­˜æ–‡ä»¶é‡å‘½å
    async function saveFileRename() {
      const directory = document.getElementById('fileDirectory').value;
      const oldName = document.getElementById('currentFileName').value;
      let newName = document.getElementById('newFileName').value;
      
      if (!newName) {
        alert('è¯·è¾“å…¥æ–°çš„æ–‡ä»¶åç§°');
        return;
      }
      
      // ç¡®ä¿æœ‰.mdåç¼€
      if (!newName.endsWith('.md')) {
        newName = `${newName}.md`;
      }
      
      try {
        const response = await fetch('/api/file', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ directory, oldName, newName })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('æ–‡ä»¶é‡å‘½åæˆåŠŸ');
          modals.renameFile.hide();
          // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
          fetchFiles(directory);
        } else {
          alert(`é‡å‘½åæ–‡ä»¶å¤±è´¥: ${result.message}`);
        }
      } catch (error) {
        console.error('é‡å‘½åæ–‡ä»¶å¤±è´¥:', error);
        alert('é‡å‘½åæ–‡ä»¶å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
      }
    }

    // ç¡®è®¤åˆ é™¤ç›®å½•
    function confirmDeleteDirectory(dirPath, displayName) {
      if (confirm(`ç¡®å®šè¦åˆ é™¤ç›®å½•"${displayName}"(${dirPath})å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        deleteDirectory(dirPath);
      }
    }
    
    // åˆ é™¤ç›®å½•
    async function deleteDirectory(dirPath) {
      try {
        const response = await fetch('/api/directory', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: dirPath })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('ç›®å½•åˆ é™¤æˆåŠŸ');
          // åˆ·æ–°ç›®å½•æ ‘
          fetchDirectories();
          // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ç›®å½•ï¼Œæ¸…ç©ºå³ä¾§
          if (selectedDirectory === dirPath) {
            selectedDirectory = '';
            document.getElementById('targetDir').value = '';
            document.getElementById('filesList').innerHTML = '<p class="text-muted">è¯·é€‰æ‹©ä¸€ä¸ªç›®å½•ä»¥æŸ¥çœ‹å…¶ä¸­çš„æ–‡ä»¶</p>';
            
            // éšè—è·¯å¾„å¸®åŠ©æ–‡æœ¬
            const targetDirHelper = document.getElementById('targetDirHelper');
            if (targetDirHelper) {
              targetDirHelper.style.display = 'none';
            }
          }
        } else {
          alert(`åˆ é™¤ç›®å½•å¤±è´¥: ${result.message}`);
        }
      } catch (error) {
        console.error('åˆ é™¤ç›®å½•å¤±è´¥:', error);
        alert('åˆ é™¤ç›®å½•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
      }
    }
    
    // ç¡®è®¤åˆ é™¤æ–‡ä»¶
    function confirmDeleteFile(filePath, fileName) {
      if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶"${fileName}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        deleteFile(filePath);
      }
    }
    
    // åˆ é™¤æ–‡ä»¶
    async function deleteFile(filePath) {
      try {
        const response = await fetch('/api/file', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: filePath })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('æ–‡ä»¶åˆ é™¤æˆåŠŸ');
          // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
          if (selectedDirectory) {
            fetchFiles(selectedDirectory);
          }
        } else {
          alert(`åˆ é™¤æ–‡ä»¶å¤±è´¥: ${result.message}`);
        }
      } catch (error) {
        console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
        alert('åˆ é™¤æ–‡ä»¶å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
      }
    }

    // æ˜¾ç¤ºä¿®æ”¹æ˜¾ç¤ºåç§°æ¨¡æ€æ¡†
    function showChangeDisplayNameModal(dirPath, displayName) {
      document.getElementById('displayNameDirPath').value = dirPath;
      document.getElementById('currentDisplayName').value = displayName || dirPath.split('/').pop();
      document.getElementById('newDisplayName').value = displayName || '';
      
      modals.changeDisplayName.show();
    }
    
    // ä¿å­˜æ˜¾ç¤ºåç§°ä¿®æ”¹
    async function saveDisplayNameChange() {
      const dirPath = document.getElementById('displayNameDirPath').value;
      const newDisplayName = document.getElementById('newDisplayName').value;
      
      if (!newDisplayName) {
        alert('è¯·è¾“å…¥æ–°çš„æ˜¾ç¤ºåç§°');
        return;
      }
      
      try {
        const response = await fetch('/api/directory-display-name', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: dirPath, newDisplayName })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('æ˜¾ç¤ºåç§°ä¿®æ”¹æˆåŠŸ');
          modals.changeDisplayName.hide();
          
          // æ›´æ–°æœ¬åœ°æ˜ å°„
          directoryMapping[dirPath] = newDisplayName;
          
          // åˆ·æ–°ç›®å½•æ ‘
          fetchDirectories();
          
          // å¦‚æœä¿®æ”¹çš„æ˜¯å½“å‰é€‰ä¸­çš„ç›®å½•ï¼Œæ›´æ–°ç›®æ ‡ç›®å½•helper
          if (selectedDirectory === dirPath) {
            const targetDirHelper = document.getElementById('targetDirHelper');
            targetDirHelper.textContent = `å½“å‰é€‰æ‹©: ${newDisplayName} (${dirPath})`;
            targetDirHelper.style.display = 'block';
          }
        } else {
          alert(`ä¿®æ”¹æ˜¾ç¤ºåç§°å¤±è´¥: ${result.message}`);
        }
      } catch (error) {
        console.error('ä¿®æ”¹æ˜¾ç¤ºåç§°å¤±è´¥:', error);
        alert('ä¿®æ”¹æ˜¾ç¤ºåç§°å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
      }
    }
  </script>
</body>
</html>